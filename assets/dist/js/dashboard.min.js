angular.module('Rest.config',[])
    .constant('ROLE', { 
    	'ADMIN' : 1, 
    	'MANAGER' : 2, 
    	"STAFF" : 3, 
    	"CLIENT" : 4 } 
    )	
	.constant('STATUS', {
		'ISSUED' : 1, 
		'ACCEPTED' : 2, 
		'INPROGRESS' : 3,
		'READY' : 4,
		'DELIVERED' : 5,
		'PAID' : 6,
		'CANCELLED' : 7} 
	);

angular.module('Rest', ['ngRoute', 'LocalStorageModule','mobile-angular-ui', 'Rest.config']);
'use strict';

angular.module('Rest')
    .config( function( $routeProvider, $locationProvider, localStorageServiceProvider ) {
    
    localStorageServiceProvider
            .setPrefix('Rest')
            .setStorageType('sessionStorage')
            .setNotify(true, true); 

    //configuring routes
    $routeProvider
    .when('/menu/:category', {
        templateUrl: 'templates/menu.html',
        controller: 'MenuController',        
    }) 
    //dashboard
    .when('/dash', {
        templateUrl: 'templates/dash.html',
        controller: 'DashController',        
    })    
    //table: where we will read table id
    .when('/table/:tableId', {
        controller: function( $location, $routeParams, tableService, localStorageService ){
            if( tableService.checkTable( $routeParams.tableId ) )
            {   
                localStorageService.set('tableId', $routeParams.tableId );                        

                $location.path("menu");
                
            } else {
                $location.path("/404");
                console.error( $routeParams.tableId, ": Table not found in db" );
            }
        }
    })
    .when('/', {
        templateUrl: 'templates/menu.html',
        controller: 'MenuController'
    })
    .when('/admin/category', {
        templateUrl: 'templates/admin/category.html',
        controller: 'AdminCategoryController'
    })
    .when('/admin/item', {
        templateUrl: 'templates/admin/item.html',
        controller: 'AdminItemController'
    });

});
/**
 * Master Controller
 */

angular.module('Rest')
    .controller('CategoryController', [ '$scope', 'localStorageService', '$http',  CategoryController ] );

function CategoryController( $scope, localStorageService, $http ) {               

    $http.get('/categories').
		success(function(data, status, headers, config) {
			$scope.categories = data;
		});
	    
}

/**
 * Master Controller
 */

angular.module('Rest')
    .controller('DashController', [ '$scope', 'localStorageService', 'Category',  DashController ] );

function DashController( $scope, localStorageService, Category ) {               

    $scope.categories = Category.getCategories();
    
}

/**
 * Master Controller
 */

angular.module('Rest')
    .controller('MasterController', [ '$scope', 'localStorageService', '$http',  MasterController ] );

function MasterController( $scope, localStorageService, $http ) {              

    $scope.modalCall = false;

    $scope.getTotalCost = function( meal ){ 

        var cost = 0;

        _.each( $scope.orders ,function( obj ){
           cost += (obj.cost * obj.quantity );
        });            

        return cost;
    };
    
    $scope.getOrders = function(){
        return localStorageService.get('orders') || [];            
    };

    $scope.ordersClass = '';

    $scope.orders = [];

    $scope.getTableId = function(){
        return localStorageService.get('tableId');
    };

    $scope.getOrders = function(){
        return localStorageService.get('orders');
    }; 

    $scope.getByCategory = function( catId ){
        return _.where( $scope.items, { catID: +catId });
    };

    $scope.getItems = function(){
        $http.get('/items').
          success(function( data, status, headers, config) {
            $scope.items = _.map( data, function(obj){ obj.quantity = 0; return obj });
          });
    }

    $scope.getItems();

    $scope.percentService = 10;

    $scope.alerts = [];

   
    
}
/**
 * Master Controller
 */
angular.module('Rest')
    .controller('MenuController', ['$scope', 'localStorageService', 'STATUS', 'Menu', '$routeParams', MenuController]);

function MenuController( $scope, localStorageService, $STATUS, Menu, $routeParams ) {

    $scope.menu = $scope.getByCategory( $routeParams.category );    

    $scope.plus = function( meal ){ 

        $scope.ordersClass = 'active';

        if( !_.findWhere( $scope.orders ,{ id: meal.id } ) )
            $scope.orders.push( meal );        

        meal.quantity += 1;
    };

    $scope.minus = function( meal ){        

        if( meal.quantity != 0 )
        {   
            meal.quantity -= 1;            
        } 
        if( meal.quantity == 0 ){
            $scope.orders.splice( _.indexOf( $scope.orders, meal ), 1 );
        }        
        if( !$scope.orders.length )
        {
            $scope.ordersClass = '';
            console.log( $scope.orders.length );
        }
    };

    $scope.addOrder = function( meal ) {        

        var orders = localStorageService.get('orders') || [];

        if( orders.length )
        {
        	orders = _.map( orders, function( obj ){
        	var found = false;
        		if( obj.id == meal.id && obj.serving == meal.serving )
        		{
        			found = true;
        			obj.quantity += meal.quantity; 
        		}

        		return obj 
        	});

        	if( !found ){
        		meal.status = $STATUS.ISSUED;
	        	orders.push( meal );
        	}			        	
        }

        localStorageService.set( 'orders', orders );        
    };       
    
}
/**
 * Master Controller
 */
angular.module('Rest')
    .controller('OrderController', ['$scope', 'localStorageService', 'STATUS', OrderController]);

function OrderController( $scope, localStorageService, STATUS ) {		  
    $scope.clearAll = function(){
      _.each( $scope.orders, function( obj ){
        obj.quantity = 0;
      });
      
      $scope.orders.splice( 0 );
    }    

    $scope.plus = function( meal ){ 

        $scope.ordersClass = 'active';

        if( !_.findWhere( $scope.orders ,{ id: meal.id } ) )
            $scope.orders.push( meal );

        meal.quantity += 1;
    };

    $scope.minus = function( meal ){        

        if( meal.quantity != 0 )
        {   
            meal.quantity -= 1;            
        } 
        if( meal.quantity == 0 ){
            $scope.orders.splice( _.indexOf( $scope.orders, meal ), 1 );
        }        
        if( !$scope.orders.length )
        {
            $scope.ordersClass = '';
            console.log( $scope.orders.length );
        }
    };

    $scope.order = function(){

        var orders = localStorageService.get('orders') || [];

        var order = {
            id: 2,
            status: STATUS.ISSUED,         
            items: $scope.orders,
            tableId: localStorageService.get('tableId'),
            cost: $scope.getTotalCost(),            
        };

        orders.push( order );

        localStorageService.set('orders', orders);

        $scope.clearAll();

        $scope.sentOrders = $scope.getOrders();
        
    };    

    $scope.totalCost = 0;

    $scope.status = [ '', 'issued', 'accepted', 'inprogress', 'ready', 'delivered', 'paid', 'cancelled' ];
    $scope.label = [ '', 'default', 'info', 'primary', 'warning', 'success', 'success', 'danger' ];

    $scope.sentOrders = $scope.getOrders();

    $scope.clearOrders = function(){
      localStorageService.remove('orders')
    };        
    
}
angular.module('Rest')
    .factory('Category', ['$http', CategoryService]);

function CategoryService( $http )
{	
	// function getItems(){
 //    	$http.get('/items').
	//       success(function(data, status, headers, config) {
	//         $scope.items = data;
	//       });
 //    }

	// var getCategories = function() {	
	// 	return [{					
	//         id: 1,
	//         name: "Meals",	        
	//       },{					
	//         id: 2,
	//         name: "Drinks",	        
	//       }];
	// };

	// return {
	// 	getCategories: function() {
	// 		return getCategories();
	// 	}
	// };
};
angular.module('Rest')
    .factory('Menu', ['$http', menuService]);

function menuService( $http )
{	

	var items = [{					
	        id: 1,
	        catId: 1,
	        name: "Palov",
	        desc: "Some desc Some desc Some desc Some desc Some desc Some Sdesc Some desc Some desc Some desc ",
	        serving: 1,
	        image: "img/palov.jpg",
	        cost: 5000,
	        quantity: 0
	      },{
	        id: 6,
	        catId: 1,
	        name: "Palov",
	        desc: "Some desc Some desc Some desc Some desc Some desc Some Sdesc Some desc Some desc Some desc ",
	        serving: 1,
	        image: "img/palov.jpg",
	        cost: 5000,
	        quantity: 0
	      },{
	        id: 2,
	        catId: 1,
	        name: "Kebab",
	        desc: "Some desc",
	        serving: 1,
	        image: "img/kebab.jpg",
	        cost: 3000,
	        quantity: 0
	      },{
	        id: 3,
	        catId: 1,
	        name: "Manti",
	        desc: "Some desc",
	        serving: 1,
	        image: "img/manti.jpg",
	        cost: 3000,
	        quantity: 0
	      },{
	        id: 4,
	        catId: 2,
	        name: "Norin",
	        desc: "Some desc",
	        serving: 1,
	        image: "img/norin.jpg",
	        cost: 3000,
	        quantity: 0
	      },{
	        id: 5,
	        catId: 2,
	        name: "Somsa",
	        desc: "Some desc",
	        serving: 1,
	        image: "img/somsa.jpg",
	        cost: 3000,
	        quantity: 1
	    }];



	var getItems = function() {		
		return items;
	};

	var getByCategory = function( catId ){	
		return _.where(items, { catId: +catId });
	};

	return {
		getMenu: function() {
			return getItems();
		},
		getByCategory: function( catId ){
			return getByCategory( catId );
		},
	};
};
angular.module('Rest')
    .factory('Orders', ['$http', OrdersService]);

function OrdersService( $http )
{	
	var getOrders = function() {	
		return [{			
	        id: 1,
	        items: [{					
		        id: 1,
		        catId: 1,
		        name: "Palov",
		        desc: "Some desc Some desc Some desc Some desc Some desc Some Sdesc Some desc Some desc Some desc ",
		        serving: 1,
		        image: "img/palov.jpg",
		        cost: 5000,
		        quantity: 0
		      },{
		        id: 6,
		        catId: 1,
		        name: "Palov",
		        desc: "Some desc Some desc Some desc Some desc Some desc Some Sdesc Some desc Some desc Some desc ",
		        serving: 1,
		        image: "img/palov.jpg",
		        cost: 5000,
		        quantity: 0
		      }],
	        tableId: 1,
	        cost: 8000,
	        percentService: 10,
	        status: 1,	              
	      },{					
	        id: 2,
	        items: [{
		        id: 3,
		        catId: 1,
		        name: "Manti",
		        desc: "Some desc",
		        serving: 1,
		        image: "img/manti.jpg",
		        cost: 3000,
		        quantity: 0
		      },{
		        id: 4,
		        catId: 2,
		        name: "Norin",
		        desc: "Some desc",
		        serving: 1,
		        image: "img/norin.jpg",
		        cost: 3000,
		        quantity: 0
		      }],
	        tableId: 2,
	        cost: 8000,
	        percentService: 10,
	        status: 1,        
	      }];
	};

	return {
		getOrders: function() {
			return getCategories();
		}
	};
};
angular.module('Rest')
    .factory('tableService', ['$http', tableService]);

function tableService( $http )
{	
	var tablesUrl = '../mock/tables.json';	

	var checkTable = function( tableId ) {
		
		// return $http({
		// 	method: 'JSON',
		// 	url: tablesUrl			
		// });
		return true;
	};

	return {
		checkTable: function( tableId ) {
			return checkTable( tableId );
		}
	};
};
angular.module('Rest')
    .controller('AdminCategoryController', [ '$scope', '$http',  AdminCategoryController ] );

function AdminCategoryController( $scope, $http ) {     

   getCategories();

    $scope.add = function( name, desc, staff ){
    	$http.post('/categories', { name: name, desc: desc, staffID: staff }).
	      success( function( data, status, headers, config ) {
	        getCategories();
	      });
    };

    $scope.del = function( id ){
    	$http.delete('/categories/' + id ).
	      success( function( data, status, headers, config ) {
	        getCategories();
	      });
    };	
    
    function getCategories(){
    	$http.get('/categories').
	      success(function(data, status, headers, config) {
	        $scope.categories = data;
	      });
    }

}
angular.module('Rest')
    .controller('AdminItemController', [ '$scope', '$http',  AdminItemController ] );

function AdminItemController( $scope, $http ) {     

    $scope.item = {};

    $scope.getItems();

    $scope.add = function( item ){
    	$http.post('/items', item ).
	      success( function( data, status, headers, config ) {
	        $scope.getItems();
	      });
    };

    // $scope.del = function( id ){
    // 	$http.delete('/items/' + id ).
	   //    success( function( data, status, headers, config ) {
	   //      getItems();
	   //    });
    // };	    

}